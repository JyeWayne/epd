select a.opd_date,a.dept_code,a.seq_no,a.fee_no,a.CHR_NO,a.PAT_NAME,a.fee_no,a.dept_room,a.room_desc,a.order_status,a.shift_no,(select exe_doc from opd_basic1 where opd_basic1.fee_no=b.fee_no and rownum = 1) as doc_name,a.doc_code,a.id_no,a.pat_id,decode(a.OPD_STATUS,'0','C','1','A','2','B','3','E','4','F','5','G','9','H') as status_name,a.opd_status,a.upd_date,a.rsv_opd_time,(select INS_doc from opd_basic1 where opd_basic1.fee_no = b.fee_no and rownum = 1) as HIA_name,a.room_desc,b.HIA_doc,(select trim(icd_code_basic.icd_code)||'_'||trim(icd_code_basic.eng_simp_desc) from icd_code_basic where icd_code_basic.icd_code=b.icd10_code1 and Rownum = 1) as icd9_desc,b.med_type,b.med_no,b.part_code,b.ins_seq_no,b.sub_desc,b.obj_desc,b.sub_desc2,b.plan_desc,b.case_type,b.med_days,b.dept_sub,(select birth_date from chr_basic where chr_basic.chr_no=a.chr_no and Rownum = 1) as birth_date,(select bed_no from bed_area where fee_no=a.fee_no and Rownum=1) as epd_bed,(select sex_type from chr_basic where chr_basic.chr_no=a.chr_no and Rownum = 1) as sex_type,(select care from epd_his where epd_his.fee_no=a.fee_no and epd_his.epd_date=a.opd_date and Rownum = 1) as exithosp,(SELECT trim(log_date)||'_'||trim(log_time) FROM EPD_TIMELOG WHERE EPD_TIMELOG.FEE_NO=a.fee_no AND EPD_TIMELOG.time_type=(SELECT time_type FROM epd_timetype_bas WHERE type_name='FOUR_HOURS' and Rownum=1) and cncl_flag='N' and Rownum=1) AS fourhours,(SELECT CLASS_NO FROM epd_his where epd_his.fee_no=b.fee_no and epd_his.epd_date=b.opd_date and epd_his.chr_no=b.chr_no and Rownum=1) as triage,'' as systolic,'' as diastolic,'' as pulse,'' as temperature,'' as triagedept,'' as date_dt,'' as weight, (select ps from doc_er_shift where doc_er_shift.fee_no=a.fee_no and Rownum = 1) as changenote,'' as shift_flag, (select fee_no from besp_ipd where besp_ipd.fee_no= a.fee_no and source_type='E' and Rownum=1) as ipdbed,a.rsv_opd_time, '' as tragenu,'' as alltrage,(SELECT FEE_NO FROM BESP_IPD WHERE BESP_IPD.FEE_NO= a.fee_no and Rownum = 1) AS epdBESPNEW,(SELECT BED_NO FROM IPD_BASIC WHERE FEE_NO=(SELECT FEE_NO_I FROM BESP_IPD WHERE BESP_IPD.FEE_NO= a.fee_no and Rownum=1) and Rownum=1) AS epdBESPIN,(SELECT CHR_NO FROM IPD_RSV WHERE CHR_NO=(SELECT CHR_NO FROM BESP_IPD  WHERE BESP_IPD.FEE_NO= a.fee_no and Rownum=1) AND IPD_RSV.RSV_DATE >= A.OPD_DATE AND SOUR_TYPE='E' and Rownum=1) AS epdBESPCHK, (select area_name from area_basic where area_no in(select decode(TRIM(epd_clinic_code),'NULL','',trim(epd_clinic_code)) from epd_vcb_basic where fee_no=a.fee_no and cncl_flag='N' and Rownum=1) and Rownum=1) as epd_area, (select end_date from epd_his where epd_his.fee_no = a.fee_no and epd_his.epd_date = a.opd_date and Rownum = 1) as end_date,(select end_time from epd_his where epd_his.fee_no = a.fee_no and epd_his.epd_date = a.opd_date and Rownum = 1) as end_time, nvl((SELECT 'Y' FROM ER_STATUS where status='8' and cncl_flag='N' and fee_no=a.fee_no and Rownum = 1),'N') as obs,(select EPD_STATUS from epd_his where epd_his.fee_no = a.fee_no and epd_his.epd_date = a.opd_date and Rownum = 1) as EPD_STATUS,(select ac_type from chr_basic where chr_basic.chr_no=a.chr_no and Rownum = 1) as AC_TYPE from reg_basic a join opd_basic b on a.opd_date = b.opd_date and a.fee_no = b.fee_no  join epd_his on a.fee_no = epd_his.fee_no and epd_his.end_date = '9999999' and epd_his.EPD_STATUS='0'  join er_status on a.fee_no = er_status.fee_no and er_status.status='8' and er_status.cncl_flag='N' and er_status.seq_no=(select max(seq_no) from er_status ers where ers.fee_no = a.fee_no and ers.status='8' and ers.cncl_flag='N') where  a.OPD_KIND='E' and a.cncl_flag='N'  order by triage,a.seq_no 
